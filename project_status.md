# BenzTraq CRM - Project Status Document

**Last Updated:** 2026-01-04  
**Purpose:** Handoff document for AI assistants to continue development

---

## üìã Project Overview

**BenzTraq** is a multi-tenant CRM/ERP system for packaging sales, built with:
- **Frontend:** Next.js 14 (App Router), React, TailwindCSS
- **Backend:** Next.js API Routes
- **Database:** Supabase (PostgreSQL)
- **Deployment:** Vercel
- **Auth:** Custom session-based auth (NOT using Supabase Auth directly in the app)

**Two Organizations:**
1. **Benz Packaging** (`benz_packaging`) - Main organization
2. **Ergopack India** (`ergopack_india`) - Subsidiary with ZERO data access to Benz

---

## üèóÔ∏è Architecture

### Authentication Flow
```
User Login ‚Üí /api/auth/login 
  ‚Üí Checks profiles table (NOT auth.users directly)
  ‚Üí Verifies password_hash (bcrypt)
  ‚Üí Creates JWT session token
  ‚Üí Sets httpOnly cookie
  ‚Üí Token includes: { id, email, organization, role, permissions }
```

**CRITICAL:** The app uses `public.profiles` as the source of truth, not `auth.users`. Profile user_ids are random UUIDs generated by the seed endpoint.

### Database Schema (Key Tables)

#### `profiles`
```sql
- user_id (PK, UUID) - Random UUID, NOT linked to auth.users
- email (unique)
- password_hash (bcrypt)
- organization (enum: 'benz_packaging' | 'ergopack_india')
- role_id (FK to roles)
- role (enum: 'vp' | 'director' | 'asm') - Legacy field
- is_active (boolean)
```

#### `documents`
```sql
- id (PK, UUID)
- doc_type (enum: 'quotation' | 'sales_order' | 'invoice')
- doc_number (text)
- doc_date (date)
- customer_name_raw (text)
- product_name (text)
- quantity (numeric)
- unit_price (numeric)
- total_value (numeric)
- status (text) - 'draft', 'sent', 'won', 'lost', etc.
- organization (text) - CRITICAL for data isolation
- created_by (UUID) - FK to profiles (DROPPED)
- salesperson_user_id (UUID) - FK to profiles (DROPPED)
```

**FK Constraints Dropped:** We removed `documents_created_by_fkey` and `documents_salesperson_user_id_fkey` because seeded users have random UUIDs that don't exist in `auth.users`.

#### `document_lines`
```sql
- id (PK)
- document_id (FK to documents)
- product_name_raw (text)
- qty (numeric)
- unit_price (numeric)
- total (numeric)
```

---

## ‚úÖ What's Working

### 1. Authentication
- ‚úÖ Login works for all seeded users (8 users)
- ‚úÖ Password: `Benz@2024` for all users
- ‚úÖ Session tokens include `organization` field
- ‚úÖ API routes extract `organization` from session via `getCurrentUser()`

### 2. Data Isolation
- ‚úÖ `GET /api/documents` filters by `currentUser.organization`
- ‚úÖ `POST /api/documents` injects `currentUser.organization`
- ‚úÖ Verified via API: Lokesh (ergopack) sees 0 Benz documents ‚úì

### 3. Document Creation
- ‚úÖ API endpoint creates quotations successfully
- ‚úÖ Returns 200 OK with document ID
- ‚úÖ Sets `status: 'draft'` by default
- ‚úÖ Organization isolation enforced

### 4. Dashboard
- ‚úÖ Displays real counts from database
- ‚úÖ Stat cards now clickable (link to documents page)
- ‚úÖ Shows team breakdown for managers
- ‚úÖ ASM view simplified (own stats only)

---

## üö® Current Blockers & Issues

### **BLOCKER #1: Documents Not Visible in UI**
**Status:** CRITICAL  
**Description:** Documents are created successfully (API returns 200), but they don't appear in the Document Centre UI.

**Root Cause:**
- The `documents/page.jsx` component crashes when rendering documents
- Error: `Cannot read properties of undefined (reading 'charAt')` in `StatusBadge`
- **Fixed in code** but not yet verified in production

**Evidence:**
```javascript
// User created quotation via API - SUCCESS
{
  "success": true,
  "document": {
    "id": "ea0263aa-561e-42e1-98f2-d77d4e898aae",
    "organization": "ergopack_india",
    "status": "draft"
  }
}

// But UI still crashes or shows empty list
```

**Fix Attempted:**
- Added null check in `StatusBadge` component
- Added `status: 'draft'` to document creation
- Deployed to production

**What to Check:**
1. Clear browser cache completely
2. Login and navigate to `/documents`
3. Check browser console for errors
4. Verify documents appear in the list

---

### **BLOCKER #2: Demo Data Still Exists**
**Status:** HIGH PRIORITY  
**Description:** User sees demo/sample documents (e.g., "Demo Quotation" created by Pulak Biswas) that were NOT created by them.

**Solution Provided:**
- SQL script available in `.gemini/antigravity/brain/.../015_cleanup_demo_data.sql`
- **User must run this in Supabase SQL Editor**

```sql
DELETE FROM document_lines;
DELETE FROM documents;
```

**Status:** Waiting for user to run cleanup script

---

### **BLOCKER #3: Customer Name Rendering**
**Status:** MEDIUM PRIORITY  
**Description:** Documents are created with `customer_name_raw` field, but UI might expect `customer.name` (relationship).

**Potential Issues:**
1. Document table has `customer_name_raw` (text field)
2. UI code might try to access `doc.customer.name` (relationship)
3. This causes undefined errors

**Fix Needed:**
- Update `DocumentsTable` component in `documents/page.jsx`
- Safely handle both `customer_name_raw` and `customer?.name`

**Code Location:**
```javascript
// File: src/app/(dashboard)/documents/page.jsx
// Look for: doc.customer?.name
// Fix: Use fallback -> doc.customer?.name || doc.customer_name_raw || 'Unknown'
```

---

## üîß Recent Fixes (Deployed)

1. **Status Badge Crash** (deployed)
   - Added `const safeStatus = status || 'draft'`
   - Prevents crash when status is undefined

2. **Dashboard Clickable Cards** (deployed)
   - Added `href` prop to `StatCard`
   - Links quotations ‚Üí `/documents?tab=quotations`
   - Links sales orders ‚Üí `/documents?tab=sales_orders`

3. **FK Constraint Removal** (SQL run by user)
   - Script: `014_fix_document_fk.sql`
   - Dropped `documents_created_by_fkey` and `documents_salesperson_user_id_fkey`
   - Allows document creation with seeded user UUIDs

---

## üéØ Next Steps (Priority Order)

### **STEP 1: Verify Document Visibility**
**Action:** Test document rendering in UI

1. Login as `lokesh@benz-packaging.com` / `Benz@2024`
2. Go to `/documents`
3. Check if the quotation appears
4. If crash ‚Üí check browser console for exact error
5. If empty but API shows documents ‚Üí check filtering logic

**Debug Query:**
```javascript
// In browser console at /documents page
fetch('/api/documents?doc_type=quotation')
  .then(r => r.json())
  .then(console.log)
```

---

### **STEP 2: Fix Customer Name Field**
**File:** `src/app/(dashboard)/documents/page.jsx`

**Problem:** UI expects `doc.customer.name` but DB has `doc.customer_name_raw`

**Fix:**
```javascript
// Find DocumentsTable component (around line 115)
// Change:
<TableCell>{doc.customer?.name || 'Unknown'}</TableCell>

// To:
<TableCell>{doc.customer?.name || doc.customer_name_raw || 'Unknown Customer'}</TableCell>
```

**Also check:**
- `dashboard/page.jsx` line ~390: `customer: d.customer?.name || 'Unknown'`
- Should be: `customer: d.customer?.name || d.customer_name_raw || 'Unknown'`

---

### **STEP 3: Clean Demo Data**
**User must run this SQL:**

```sql
-- In Supabase SQL Editor
DELETE FROM document_lines;
DELETE FROM documents;

-- Verify cleanup
SELECT COUNT(*) FROM documents; -- Should be 0
```

---

### **STEP 4: Create Real Test Data**
After cleanup, create a test quotation:

**Via UI:**
1. Login as Lokesh
2. Click "Create Quotation"
3. Fill form:
   - Customer: "ABC Industries"
   - Product: "Corrugated Boxes"
   - Quantity: 1000
   - Price: 50
4. Submit
5. Verify it appears in Document Centre

**Via API (for debugging):**
```powershell
$session = New-Object Microsoft.PowerShell.Commands.WebRequestSession
$login = Invoke-WebRequest -Method Post -Uri "https://benztraq.vercel.app/api/auth/login" -ContentType "application/json" -Body '{"email":"lokesh@benz-packaging.com","password":"Benz@2024"}' -WebSession $session
$doc = Invoke-WebRequest -Method Post -Uri "https://benztraq.vercel.app/api/documents" -ContentType "application/json" -Body '{"doc_type":"quotation","customer_name":"ABC Industries","product_name":"Corrugated Boxes","quantity":1000,"uom":"pcs","unit_price":50}' -WebSession $session
$doc.StatusCode  # Should be 200
```

---

## üìÅ Important File Locations

### API Routes
- `src/app/api/auth/login/route.js` - Authentication
- `src/app/api/documents/route.js` - CRUD for documents
- `src/app/api/admin/seed-users/route.js` - User seeding

### Frontend Components
- `src/app/(dashboard)/dashboard/page.jsx` - Main dashboard
- `src/app/(dashboard)/documents/page.jsx` - Document Centre (LIST)
- `src/app/(dashboard)/documents/new/page.jsx` - Create document form
- `src/lib/utils/session.js` - Session management

### Database
- `supabase/migrations/001_initial_schema.sql` - Original schema
- `supabase/migrations/003_rbac_schema.sql` - RBAC setup
- `.gemini/antigravity/brain/.../` - SQL fix scripts (007-015)

---

## üîê User Credentials

**All passwords:** `Benz@2024`

**Benz Packaging Users:**
- `laxmi@benz-packaging.com` (Developer, VP)
- `pulak@benz-packaging.com` (Head of Sales, Director)
- `abhishek@benz-packaging.com` (ASM)
- `wh.jaipur@benz-packaging.com` (ASM)
- `asm1@benz-packaging.com` (ASM)
- `asm2@benz-packaging.com` (ASM)
- `asm3@benz-packaging.com` (ASM)

**Ergopack India Users:**
- `lokesh@benz-packaging.com` (VP Operations, Head of Sales)
  - **MUST NOT see any Benz Packaging data**
  - Organization: `ergopack_india`

---

## üß™ Testing Checklist

### Data Isolation Test
- [ ] Login as Lokesh ‚Üí Create quotation ‚Üí Verify `organization=ergopack_india`
- [ ] Logout ‚Üí Login as Abhishek ‚Üí Verify Lokesh's quotation is NOT visible
- [ ] Login as Pulak ‚Üí Verify count includes ALL Benz users' documents

### Document Creation Test
- [ ] Create quotation ‚Üí Returns 200 OK
- [ ] Quotation appears in Document Centre list
- [ ] Quotation shows correct status badge
- [ ] Customer name displays correctly
- [ ] "Convert to Sales Order" button works

### Dashboard Test
- [ ] Quotation count matches document list
- [ ] Sales order count matches document list
- [ ] Clicking counts navigates to `/documents`
- [ ] Team breakdown shows real user names
- [ ] No "Unknown" or "Demo" users appear

---

## ‚ö†Ô∏è Known Quirks

1. **Seeded Users Don't Exist in auth.users**
   - The seed endpoint creates profiles with random UUIDs
   - These UUIDs don't exist in `auth.users`
   - This is intentional for now (custom auth, not Supabase Auth)
   - FK constraints had to be dropped

2. **Organization Field is Critical**
   - EVERY document query MUST filter by `organization`
   - EVERY document insert MUST include `organization`
   - Forgetting this breaks data isolation

3. **Session Token Contains Organization**
   - `getCurrentUser()` returns `{ id, email, organization, role, ... }`
   - Use `currentUser.organization` for filtering
   - Fallback: `currentUser.organization || 'benz_packaging'`

4. **Status Field Recently Added**
   - Old documents might have `status: null`
   - UI handles this with `safeStatus = status || 'draft'`

---

## üêõ Debugging Tips

### Check if Document Creation Works (API Level)
```powershell
# PowerShell
$session = New-Object Microsoft.PowerShell.Commands.WebRequestSession
$login = Invoke-WebRequest -Method Post -Uri "https://benztraq.vercel.app/api/auth/login" -ContentType "application/json" -Body '{"email":"lokesh@benz-packaging.com","password":"Benz@2024"}' -WebSession $session
$doc = Invoke-WebRequest -Method Post -Uri "https://benztraq.vercel.app/api/documents" -ContentType "application/json" -Body '{"doc_type":"quotation","customer_name":"Test","product_name":"Test","quantity":10,"uom":"pcs","unit_price":100}' -WebSession $session
$doc.StatusCode # Should be 200
```

### Check Document List (API Level)
```powershell
$docs = Invoke-WebRequest -Method Get -Uri "https://benztraq.vercel.app/api/documents?doc_type=quotation" -WebSession $session
$docs.Content # Should show documents
```

### Check Browser Console
1. Open browser DevTools (F12)
2. Go to Console tab
3. Look for red errors
4. Common errors:
   - `Cannot read properties of undefined` ‚Üí Missing null check
   - `JWT malformed` ‚Üí Session expired, logout/login
   - `401 Unauthorized` ‚Üí Not logged in

### Force Refresh
1. Clear browser cache (Ctrl+Shift+Del)
2. Hard reload (Ctrl+Shift+R)
3. Logout and login again
4. Check if issue persists

---

## üìä Current Database State

**Tables:**
- `profiles`: 8 users seeded
- `documents`: Unknown (may contain demo data)
- `document_lines`: Unknown
- `roles`: 3 roles (developer, head_of_sales, asm)
- `permissions`: Permission matrix for RBAC

**Known Issues:**
- Demo data needs cleanup
- Some documents might have `status: null`
- Customer/Product FKs not enforced (using _raw fields)

---

## üöÄ Future Enhancements (Not Urgent)

1. **Implement Supabase RLS**
   - Add Row Level Security policies
   - Filter by `organization` at DB level
   - Requires linking profiles to `auth.users`

2. **Real Customer/Product Tables**
   - Currently using `customer_name_raw` text field
   - Should have proper `customers` and `products` tables
   - With FK relationships

3. **PDF Generation**
   - Generate quotation PDFs
   - Print sales orders
   - Email to customers

4. **Better Error Handling**
   - More specific error messages
   - Toast notifications for success/failure
   - Form validation improvements

---

## üìû Getting Help

**If Stuck:**
1. Check this document first
2. Review walkthrough.md in `.gemini/antigravity/brain/...` folder
3. Check SQL scripts in `.gemini` folder (001-015)
4. Search codebase for patterns:
   - `getCurrentUser()` - Session management
   - `.eq('organization',` - Data isolation
   - `customer_name_raw` - Customer field handling

**Common Commands:**
```bash
# Deploy to production
vercel --prod --yes

# Run SQL in Supabase
# Go to: https://supabase.com/dashboard ‚Üí Your Project ‚Üí SQL Editor

# Check logs
vercel logs benztraq --prod

# Test API locally
npm run dev
# Then: http://localhost:3000/api/documents
```

---

## ‚ú® Success Criteria

The project is "done" when:
- [x] Login works for all users
- [x] Data isolation verified (Lokesh sees 0 Benz docs)
- [ ] Documents appear in Document Centre UI ‚Üê **CURRENT BLOCKER**
- [ ] No demo/sample data visible
- [ ] Dashboard widgets clickable and functional
- [ ] Create quotation ‚Üí appears in list
- [ ] Convert quotation ‚Üí sales order works
- [ ] Only real user names appear (no "Unknown")

---

**End of Document**  
**Continue from:** Fix document visibility in UI (Step 1-2 above)
